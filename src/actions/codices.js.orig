import { browserHistory } from 'react-router';
import xhr from 'xhr';
import { codexUrl } from '../config';
import { parseIncomingCodex, parseOutgoingCodex } from '../utils/parsers/codex';

const DEFAULT_HEADERS = {
	Accept: 'application/json',
	'Content-Type': 'application/json',
};

function fetch(url, cb) {
	const options = {
		headers: DEFAULT_HEADERS,
		url,
	};

	const done = (err, response, body) => {
		if (response.statusCode === 404) {
			browserHistory.push('/404');
		}

		const parsedJson = parseIncomingCodex(JSON.parse(body));

		cb(parsedJson);
	};

	xhr(options, done);
}

<<<<<<< 90950dafe9354ff50ad4254ded41b8d8ed6e5a84
const fetchCodex = (id) => (dispatch, getState) => {
	dispatch({type: "REQUEST_CODEX"});

	fetch(`${config.codexUrl}/${id}/expandlinks`, (response) =>
		dispatch({
			type: "RECEIVE_CODEX",
			response: response
		})
	);
}

let setCodex = (id) => (dispatch, getState) => {
	let codices = getState().codices;
=======
export const setCodex = (id) => (dispatch, getState) => {
	const codices = getState().codices;
>>>>>>> Refactor to use React 15.0 and friends WiP

	if (codices.current !== null && codices.current.pid === id) {
		return;
	}

	const	found = codices.all.filter((codex) => codex.pid === id);

	if (found.length) {
		dispatch({
			type: 'SET_CURRENT_CODEX',
			current: found[0],
		});
	} else {
<<<<<<< 90950dafe9354ff50ad4254ded41b8d8ed6e5a84
		dispatch(fetchCodex(id));
=======
		dispatch({ type: 'REQUEST_CODEX' });

		fetch(`${codexUrl}/${id}/expandlinks`, (response) =>
			dispatch({
				type: 'RECEIVE_CODEX',
				response,
			})
		);
>>>>>>> Refactor to use React 15.0 and friends WiP
	}
};

export function saveCodex() {
	return (dispatch, getState) => {
		const codex = getState().codices.current;

		const method = codex.pid === '' ?
			'post' :
			'put';

		dispatch({ type: 'SAVE_CODEX' });

		xhr({
			body: JSON.stringify(parseOutgoingCodex(codex)),
			headers: { ...DEFAULT_HEADERS, ...{
				Authorization: localStorage.getItem('hi-marschol2-auth-token'),
			} },
			method,
			url: `${codexUrl}/${codex.pid}`,
		}, (err, response) => {
			if (err) console.error(err);

			let id = codex.pid;

			if (response.headers.hasOwnProperty('location')) {
				const lastIndex = response.headers.location.lastIndexOf('/');
				id = response.headers.location.substr(lastIndex + 1);
			}

<<<<<<< 90950dafe9354ff50ad4254ded41b8d8ed6e5a84
			dispatch({type: "SAVED_CODEX"});
			dispatch(fetchCodex(id));
=======
			dispatch({ type: 'SAVED_CODEX' });
			dispatch(setCodex(id));
>>>>>>> Refactor to use React 15.0 and friends WiP
		});
	};
}

export function removeCodex() {
	return (dispatch, getState) => {
		const codex = getState().codices.current;

		xhr({
			headers: { ...DEFAULT_HEADERS, ...{
				Authorization: getState().user.token,
			} },
			method: 'delete',
			url: `${codexUrl}/${codex.pid}`,
		}, () => {
			browserHistory.push('/');
			dispatch({
				type: 'REMOVE_CODEX',
				id: codex.pid,
			});
		});
	};
}
